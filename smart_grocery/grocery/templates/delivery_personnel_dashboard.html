<h1>Welcome to the Delivery Personnel Dashboard</h1>
<ul>
    <li><a href="{% url 'home' %}">Home</a></li>
    <li><a href="{% url 'logout' %}">Logout</a></li>
</ul>

<h2>Orders to Deliver</h2>
<p>Number of Orders: {{ order_count }}</p>

<table>
    <thead>
        <tr>
            <th>Order ID</th>
            <th>Status</th>
            <th>Total Amount</th>
            <th>Customer Name</th>
            <th>Customer Address</th>
            <th>Vendor</th>
            <th>Vendor Business Name</th>
            <th>Vendor Contact</th>
            <th>Vendor Address</th>
            <th>Products</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="orders-table-body">
        {% for order in delivery_orders %}
            <tr id="order-{{ order.id }}">
                <td>{{ order.id }}</td>
                <td id="status-{{ order.id }}">{{ order.status }}</td>
                <td>â‚¹{{ order.total_amount }}</td>
                <td>{{ order.customer.user.username }}</td>
                <td>{{ order.customer.address }}</td>
                <td>{{ order.vendor.profile.user.username }}</td>
                <td>{{ order.vendor.business_name }}</td>
                <td>{{ order.vendor.phone }}</td>
                <td>{{ order.vendor.business_address }}</td>
                <td>
                    <ul>
                        {% for item in order.items.all %}
                            <li>{{ item.product.name }} - Quantity: {{ item.quantity }}</li>
                        {% endfor %}
                    </ul>
                </td>
                <td>
                    <form method="post" action="{% url 'update_order_status' order.id %}">
                        {% csrf_token %}
                        <select name="status" onchange="this.form.submit()">
                            {% for status in order.STATUS_CHOICES %}
                                <option value="{{ status.0 }}" {% if order.status == status.0 %}selected{% endif %}>
                                    {{ status.1 }}
                                </option>
                            {% endfor %}
                        </select>
                    </form>
                </td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="11">No deliveries assigned.</td>
            </tr>
        {% endfor %}
    </tbody>
</table>

<a href="{% url 'home' %}">Back to Home</a>

<style>
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #f2f2f2;
    }

    tbody tr:hover {
        background-color: #f1f1f1;
    }

    ul {
        margin: 0;
        padding: 0;
        list-style: none;
    }
</style>

<script>
    const deliveryStatusSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/delivery-status/'
    );

    deliveryStatusSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const orderId = data.order_id;  // Use order_id instead of delivery_id
        const status = data.status;

        // Update the status on the page
        const statusElement = document.getElementById(`status-${orderId}`);
        if (statusElement) {
            statusElement.textContent = status;
        }
    };

    async function updateOrderStatus(orderId, newStatus) {
    const payload = JSON.stringify({ 'status': newStatus });
    const csrfToken = getCookie('csrftoken');

    try {
        const response = await fetch(`/grocery/update-order-status/${orderId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: payload
        });

        if (response.ok) {
            const data = await response.json();
            console.log(`Order ${orderId} updated to ${newStatus}`);
            // Update the status on the UI
            document.querySelector(`#status-${orderId}`).textContent = newStatus;
        } else {
            console.error(`Failed to update order ${orderId}`);
        }
    } catch (error) {
        console.error(`Error occurred: ${error}`);
    }
}
</script>